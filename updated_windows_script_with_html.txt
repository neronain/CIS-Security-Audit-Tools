# CIS Windows 10/11 Security Audit Script with HTML Export
# Version: 2.0
# Author: Security Audit Tool
# Description: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Ç‡∏≠‡∏á Windows ‡∏ï‡∏≤‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô CIS ‡∏û‡∏£‡πâ‡∏≠‡∏° HTML Report
# Requires: PowerShell 5.1+, Run as Administrator

param(
    [switch]$Help,
    [switch]$CreateHardening,
    [switch]$ExportResults,
    [switch]$ExportHTML,
    [switch]$ExportCSV,
    [string]$OutputPath = "C:\Temp",
    [string]$ReportTitle = "CIS Windows Security Audit Report",
    [string]$CustomSystemInfo = ""
)

# Global Variables
$script:PassCount = 0
$script:FailCount = 0
$script:WarnCount = 0
$script:TotalChecks = 0
$script:LogFile = ""
$script:Results = @()

# Color definitions for console output
$Colors = @{
    'PASS' = 'Green'
    'FAIL' = 'Red'
    'WARN' = 'Yellow'
    'INFO' = 'Cyan'
    'HEADER' = 'Magenta'
}

# Initialize script
function Initialize-Script {
    Clear-Host
    
    # Check PowerShell version
    if ($PSVersionTable.PSVersion.Major -lt 5) {
        Write-Host "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ PowerShell 5.1 ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏Å‡∏ß‡πà‡∏≤" -ForegroundColor Red
        exit 1
    }
    
    # Check if running as Administrator
    $currentUser = [Security.Principal.WindowsIdentity]::GetCurrent()
    $principal = New-Object Security.Principal.WindowsPrincipal($currentUser)
    if (-not $principal.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
        Write-Host "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏±‡∏ô‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Administrator" -ForegroundColor Red
        exit 1
    }
    
    # Create output directory
    if (-not (Test-Path $OutputPath)) {
        New-Item -ItemType Directory -Path $OutputPath -Force | Out-Null
    }
    
    # Set log file path
    $script:LogFile = Join-Path $OutputPath "CIS_Windows_Audit_$(Get-Date -Format 'yyyyMMdd_HHmmss').log"
    
    # Display header
    Write-Host "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor $Colors.HEADER
    Write-Host "‚ïë      CIS Windows 10/11 Security Audit Script v2.0             ‚ïë" -ForegroundColor $Colors.HEADER
    Write-Host "‚ïë                   with HTML Report Export                     ‚ïë" -ForegroundColor $Colors.HEADER
    Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" -ForegroundColor $Colors.HEADER
    Write-Host ""
}

# Function to write results
function Write-Result {
    param(
        [string]$Status,
        [string]$CheckID,
        [string]$Description,
        [string]$Details = "",
        [string]$Recommendation = "",
        [string]$RiskLevel = "Medium"
    )
    
    $script:TotalChecks++
    
    # Create result object
    $resultObj = [PSCustomObject]@{
        CheckID = $CheckID
        Status = $Status
        Description = $Description
        Details = $Details
        Recommendation = $Recommendation
        RiskLevel = $RiskLevel
        Timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    }
    
    $script:Results += $resultObj
    
    # Update counters
    switch ($Status) {
        'PASS' { $script:PassCount++ }
        'FAIL' { $script:FailCount++ }
        'WARN' { $script:WarnCount++ }
    }
    
    # Display to console
    $statusText = "[$Status]".PadRight(6)
    $color = $Colors[$Status]
    if ($RiskLevel -eq "Critical" -and $Status -eq "FAIL") {
        $color = 'DarkRed'
    }
    
    Write-Host $statusText -ForegroundColor $color -NoNewline
    Write-Host " $Description"
    
    if ($Details) {
        Write-Host "       ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: $Details" -ForegroundColor Gray
    }
    
    if ($Recommendation) {
        Write-Host "       ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: $Recommendation" -ForegroundColor Gray
    }
    
    if ($RiskLevel -eq "Critical") {
        Write-Host "       ‚ö†Ô∏è  ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á: ‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å" -ForegroundColor DarkRed
    }
    
    # Log to file
    $logEntry = "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') [$Status] [$RiskLevel] $CheckID - $Description"
    if ($Details) { $logEntry += " | Details: $Details" }
    if ($Recommendation) { $logEntry += " | Recommendation: $Recommendation" }
    
    Add-Content -Path $script:LogFile -Value $logEntry
}

# Get system and domain information
function Get-SystemInfo {
    Write-Host "`n=== ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö ===" -ForegroundColor $Colors.HEADER
    
    $os = Get-CimInstance -ClassName Win32_OperatingSystem
    $computer = Get-CimInstance -ClassName Win32_ComputerSystem
    
    Write-Result "INFO" "SYS001" "OS Version: $($os.Caption) Build $($os.BuildNumber)"
    Write-Result "INFO" "SYS002" "Computer Name: $($computer.Name)"
    Write-Result "INFO" "SYS003" "Domain: $($computer.Domain)"
    Write-Result "INFO" "SYS004" "Total Physical Memory: $([math]::Round($computer.TotalPhysicalMemory/1GB, 2)) GB"
    Write-Result "INFO" "SYS005" "Log File: $script:LogFile"
}

# 1. Account Policies
function Test-AccountPolicies {
    Write-Host "`n=== 1. ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Account Policies ===" -ForegroundColor $Colors.HEADER
    
    try {
        # Get security policy
        $tempFile = "$env:TEMP\secpol.cfg"
        $secpol = secedit /export /cfg $tempFile /quiet
        
        if (Test-Path $tempFile) {
            $secpolContent = Get-Content $tempFile -ErrorAction SilentlyContinue
            
            if ($secpolContent) {
                # Password Policy
                $minPwdLength = ($secpolContent | Where-Object { $_ -match "MinimumPasswordLength" }) -replace ".*= "
                if ([int]$minPwdLength -ge 14) {
                    Write-Result "PASS" "ACC001" "Minimum Password Length: $minPwdLength"
                } elseif ([int]$minPwdLength -ge 8) {
                    Write-Result "WARN" "ACC001" "Minimum Password Length: $minPwdLength" -Recommendation "‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô 14 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤"
                } else {
                    Write-Result "FAIL" "ACC001" "Minimum Password Length: $minPwdLength" -RiskLevel "High" -Recommendation "‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 8 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£"
                }
                
                # Password complexity
                $pwdComplexity = ($secpolContent | Where-Object { $_ -match "PasswordComplexity" }) -replace ".*= "
                if ($pwdComplexity -eq "1") {
                    Write-Result "PASS" "ACC002" "Password Complexity: ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô"
                } else {
                    Write-Result "FAIL" "ACC002" "Password Complexity: ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" -RiskLevel "High" -Recommendation "‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Password Complexity"
                }
                
                # Account lockout threshold
                $lockoutThreshold = ($secpolContent | Where-Object { $_ -match "LockoutBadCount" }) -replace ".*= "
                if ([int]$lockoutThreshold -le 5 -and [int]$lockoutThreshold -gt 0) {
                    Write-Result "PASS" "ACC003" "Account Lockout Threshold: $lockoutThreshold"
                } else {
                    Write-Result "FAIL" "ACC003" "Account Lockout Threshold: $lockoutThreshold" -RiskLevel "Medium" -Recommendation "‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 1-5"
                }
                
                # Password history
                $pwdHistory = ($secpolContent | Where-Object { $_ -match "PasswordHistorySize" }) -replace ".*= "
                if ([int]$pwdHistory -ge 12) {
                    Write-Result "PASS" "ACC004" "Password History: $pwdHistory passwords"
                } else {
                    Write-Result "WARN" "ACC004" "Password History: $pwdHistory passwords" -Recommendation "‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 12"
                }
                
                # Maximum password age
                $maxPwdAge = ($secpolContent | Where-Object { $_ -match "MaximumPasswordAge" }) -replace ".*= "
                if ([int]$maxPwdAge -le 90 -and [int]$maxPwdAge -gt 0) {
                    Write-Result "PASS" "ACC005" "Maximum Password Age: $maxPwdAge days"
                } else {
                    Write-Result "WARN" "ACC005" "Maximum Password Age: $maxPwdAge days" -Recommendation "‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 30-90 ‡∏ß‡∏±‡∏ô"
                }
                
                # Minimum password age
                $minPwdAge = ($secpolContent | Where-Object { $_ -match "MinimumPasswordAge" }) -replace ".*= "
                if ([int]$minPwdAge -ge 1) {
                    Write-Result "PASS" "ACC006" "Minimum Password Age: $minPwdAge days"
                } else {
                    Write-Result "WARN" "ACC006" "Minimum Password Age: $minPwdAge days" -Recommendation "‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ß‡∏±‡∏ô"
                }
            }
            
            Remove-Item $tempFile -ErrorAction SilentlyContinue
        }
    }
    catch {
        Write-Result "WARN" "ACC999" "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Account Policies ‡πÑ‡∏î‡πâ" -Details $_.Exception.Message
    }
}

# 2. Local Policies
function Test-LocalPolicies {
    Write-Host "`n=== 2. ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Local Policies ===" -ForegroundColor $Colors.HEADER
    
    try {
        # Check if Guest account is disabled
        $guestAccount = Get-LocalUser -Name "Guest" -ErrorAction SilentlyContinue
        if ($guestAccount -and -not $guestAccount.Enabled) {
            Write-Result "PASS" "LOC001" "Guest Account: ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô"
        } elseif ($guestAccount -and $guestAccount.Enabled) {
            Write-Result "FAIL" "LOC001" "Guest Account: ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" -RiskLevel "High" -Recommendation "‡∏Ñ‡∏ß‡∏£‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Guest Account"
        } else {
            Write-Result "WARN" "LOC001" "Guest Account: ‡πÑ‡∏°‡πà‡∏û‡∏ö"
        }
        
        # Check Administrator account rename
        $adminAccount = Get-LocalUser | Where-Object { $_.SID -like "*-500" }
        if ($adminAccount.Name -ne "Administrator") {
            Write-Result "PASS" "LOC002" "Administrator Account: ‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô '$($adminAccount.Name)'"
        } else {
            Write-Result "WARN" "LOC002" "Administrator Account: ‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠ 'Administrator'" -Recommendation "‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠ Administrator account"
        }
    }
    catch {
        Write-Result "WARN" "LOC999" "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Local User Accounts ‡πÑ‡∏î‡πâ" -Details $_.Exception.Message
    }
    
    # Security Options via Registry
    $securityChecks = @(
        @{
            ID = "LOC003"
            Path = "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management"
            Name = "ClearPageFileAtShutdown"
            ExpectedValue = 1
            Description = "Clear Virtual Memory Pagefile"
            RiskLevel = "Medium"
        },
        @{
            ID = "LOC004"
            Path = "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa"
            Name = "LimitBlankPasswordUse"
            ExpectedValue = 1
            Description = "Accounts: Limit local account use of blank passwords"
            RiskLevel = "High"
        },
        @{
            ID = "LOC005"
            Path = "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa"
            Name = "NoLMHash"
            ExpectedValue = 1
            Description = "Network security: Do not store LAN Manager hash"
            RiskLevel = "Medium"
        },
        @{
            ID = "LOC006"
            Path = "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System"
            Name = "EnableLUA"
            ExpectedValue = 1
            Description = "User Account Control (UAC)"
            RiskLevel = "Critical"
        }
    )
    
    foreach ($check in $securityChecks) {
        try {
            $value = Get-ItemProperty -Path $check.Path -Name $check.Name -ErrorAction SilentlyContinue
            if ($value -and $value.($check.Name) -eq $check.ExpectedValue) {
                Write-Result "PASS" $check.ID $check.Description
            } else {
                $currentValue = if ($value) { $value.($check.Name) } else { "‡πÑ‡∏°‡πà‡∏û‡∏ö" }
                Write-Result "FAIL" $check.ID $check.Description -Details "‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: $currentValue" -Recommendation "‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô $($check.ExpectedValue)" -RiskLevel $check.RiskLevel
            }
        }
        catch {
            Write-Result "WARN" $check.ID $check.Description -Details "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ Registry ‡πÑ‡∏î‡πâ"
        }
    }
}

# 3. Windows Firewall
function Test-WindowsFirewall {
    Write-Host "`n=== 3. ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Windows Firewall ===" -ForegroundColor $Colors.HEADER
    
    try {
        $firewallProfiles = @('Domain', 'Private', 'Public')
        
        foreach ($profile in $firewallProfiles) {
            $fw = Get-NetFirewallProfile -Name $profile
            
            if ($fw.Enabled -eq $true) {
                Write-Result "PASS" "FW00$($firewallProfiles.IndexOf($profile) + 1)" "Windows Firewall ($profile): ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô"
            } else {
                Write-Result "FAIL" "FW00$($firewallProfiles.IndexOf($profile) + 1)" "Windows Firewall ($profile): ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" -RiskLevel "Critical" -Recommendation "‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Firewall"
            }
            
            # Check inbound/outbound rules
            if ($fw.DefaultInboundAction -eq 'Block') {
                Write-Result "PASS" "FW00$($firewallProfiles.IndexOf($profile) + 4)" "Default Inbound Action ($profile): Block"
            } else {
                Write-Result "WARN" "FW00$($firewallProfiles.IndexOf($profile) + 4)" "Default Inbound Action ($profile): $($fw.DefaultInboundAction)" -Recommendation "‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô Block"
            }
        }
        
        # Check for dangerous firewall rules
        $dangerousRules = Get-NetFirewallRule | Where-Object { 
            $_.Enabled -eq "True" -and 
            $_.Direction -eq "Inbound" -and 
            $_.Action -eq "Allow" -and
            (Get-NetFirewallAddressFilter -AssociatedNetFirewallRule $_).RemoteAddress -contains "Any"
        }
        
        if ($dangerousRules.Count -eq 0) {
            Write-Result "PASS" "FW007" "‡πÑ‡∏°‡πà‡∏û‡∏ö Firewall rules ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢"
        } else {
            Write-Result "WARN" "FW007" "‡∏û‡∏ö $($dangerousRules.Count) inbound rules ‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï Any address" -Recommendation "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏Å‡∏±‡∏î scope ‡∏Ç‡∏≠‡∏á firewall rules"
        }
    }
    catch {
        Write-Result "WARN" "FW999" "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Windows Firewall ‡πÑ‡∏î‡πâ" -Details $_.Exception.Message
    }
}

# 4. Windows Defender
function Test-WindowsDefender {
    Write-Host "`n=== 4. ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Windows Defender ===" -ForegroundColor $Colors.HEADER
    
    try {
        $defender = Get-MpPreference -ErrorAction SilentlyContinue
        $status = Get-MpComputerStatus -ErrorAction SilentlyContinue
        
        if ($status) {
            # Real-time protection
            if ($status.RealTimeProtectionEnabled) {
                Write-Result "PASS" "DEF001" "Real-time Protection: ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô"
            } else {
                Write-Result "FAIL" "DEF001" "Real-time Protection: ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" -RiskLevel "Critical" -Recommendation "‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Real-time Protection"
            }
            
            # Antivirus signature version
            $signatureAge = (Get-Date) - $status.AntivirusSignatureLastUpdated
            if ($signatureAge.Days -le 7) {
                Write-Result "PASS" "DEF002" "Antivirus Signatures: ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î $($signatureAge.Days) ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß"
            } else {
                Write-Result "WARN" "DEF002" "Antivirus Signatures: ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î $($signatureAge.Days) ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß" -Recommendation "‡∏Ñ‡∏ß‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó signature"
            }
            
            # Cloud protection
            if ($defender -and $defender.MAPSReporting -ne 0) {
                Write-Result "PASS" "DEF003" "Cloud Protection: ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô"
            } else {
                Write-Result "WARN" "DEF003" "Cloud Protection: ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" -Recommendation "‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Cloud Protection"
            }
            
            # Behavior monitoring
            if ($status.BehaviorMonitorEnabled) {
                Write-Result "PASS" "DEF004" "Behavior Monitoring: ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô"
            } else {
                Write-Result "WARN" "DEF004" "Behavior Monitoring: ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" -Recommendation "‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Behavior Monitoring"
            }
            
            # Check exclusions
            if ($defender.ExclusionPath.Count -eq 0) {
                Write-Result "PASS" "DEF005" "‡πÑ‡∏°‡πà‡∏°‡∏µ Path Exclusions ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î"
            } else {
                Write-Result "WARN" "DEF005" "‡∏°‡∏µ $($defender.ExclusionPath.Count) Path Exclusions" -Details ($defender.ExclusionPath -join ", ") -Recommendation "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á exclusions"
            }
        } else {
            Write-Result "WARN" "DEF999" "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Windows Defender ‡πÑ‡∏î‡πâ"
        }
    }
    catch {
        Write-Result "WARN" "DEF999" "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Windows Defender ‡πÑ‡∏î‡πâ" -Details $_.Exception.Message
    }
}

# 5. Windows Updates
function Test-WindowsUpdates {
    Write-Host "`n=== 5. ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Windows Updates ===" -ForegroundColor $Colors.HEADER
    
    try {
        # Check Windows Update service
        $wuService = Get-Service -Name "wuauserv" -ErrorAction SilentlyContinue
        if ($wuService -and $wuService.Status -eq "Running") {
            Write-Result "PASS" "UPD001" "Windows Update Service: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô"
        } else {
            Write-Result "WARN" "UPD001" "Windows Update Service: ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô" -Recommendation "‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Windows Update Service"
        }
        
        # Check automatic updates setting
        $auOptions = Get-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\WindowsUpdate\Auto Update" -Name "AUOptions" -ErrorAction SilentlyContinue
        if ($auOptions -and $auOptions.AUOptions -eq 4) {
            Write-Result "PASS" "UPD002" "Automatic Updates: ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Install automatically)"
        } elseif ($auOptions -and $auOptions.AUOptions -eq 3) {
            Write-Result "WARN" "UPD002" "Automatic Updates: Download ‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á" -Recommendation "‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥"
        } else {
            Write-Result "FAIL" "UPD002" "Automatic Updates: ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°" -RiskLevel "High" -Recommendation "‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Automatic Updates"
        }
        
        # Check last update installation
        try {
            $lastUpdate = Get-HotFix | Sort-Object InstalledOn -Descending | Select-Object -First 1
            if ($lastUpdate -and $lastUpdate.InstalledOn) {
                $daysSinceUpdate = (Get-Date) - $lastUpdate.InstalledOn
                if ($daysSinceUpdate.Days -le 30) {
                    Write-Result "PASS" "UPD003" "Last Update: $($daysSinceUpdate.Days) ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß ($($lastUpdate.HotFixID))"
                } else {
                    Write-Result "WARN" "UPD003" "Last Update: $($daysSinceUpdate.Days) ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß ($($lastUpdate.HotFixID))" -Recommendation "‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á updates"
                }
            } else {
                Write-Result "WARN" "UPD003" "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Update ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î"
            }
        }
        catch {
            Write-Result "WARN" "UPD003" "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Updates ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏î‡πâ"
        }
        
        # Check Windows Update for Business settings
        $wufbSettings = Get-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate" -ErrorAction SilentlyContinue
        if ($wufbSettings) {
            if ($wufbSettings.DeferFeatureUpdates -eq 1) {
                Write-Result "PASS" "UPD004" "Feature Updates: Deferred (recommended for business)"
            } else {
                Write-Result "WARN" "UPD004" "Feature Updates: Not deferred" -Recommendation "‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤ defer feature updates ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö business environment"
            }
        }
    }
    catch {
        Write-Result "WARN" "UPD999" "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Windows Updates ‡πÑ‡∏î‡πâ" -Details $_.Exception.Message
    }
}

# Function to generate HTML report
function Export-HTMLReport {
    param(
        [string]$OutputPath = "C:\Temp",
        [string]$Title = "CIS Windows Security Audit Report"
    )
    
    $htmlFile = Join-Path $OutputPath "CIS_Windows_Audit_Report_$(Get-Date -Format 'yyyyMMdd_HHmmss').html"
    
    Write-Host "`n‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô HTML..." -ForegroundColor Cyan
    
    # Get system information
    $os = Get-CimInstance -ClassName Win32_OperatingSystem
    $computer = Get-CimInstance -ClassName Win32_ComputerSystem
    $systemName = $computer.Name
    $osVersion = "$($os.Caption) Build $($os.BuildNumber)"
    $auditDate = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $domain = $computer.Domain
    $generationTime = Get-Date -Format "yyyy-MM-dd HH:mm:ss K"
    
    # Calculate security score
    $securityScore = 0
    if ($script:TotalChecks -gt 0) {
        $securityScore = [math]::Round(($script:PassCount * 100) / $script:TotalChecks, 1)
    }
    
    # Determine security level
    $securityLevel = "‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á"
    $securityLevelClass = "level-poor"
    if ($securityScore -ge 85) {
        $securityLevel = "‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°"
        $securityLevelClass = "level-excellent"
    } elseif ($securityScore -ge 70) {
        $securityLevel = "‡∏î‡∏µ"
        $securityLevelClass = "level-good"
    } elseif ($securityScore -ge 50) {
        $securityLevel = "‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á"
        $securityLevelClass = "level-medium"
    }
    
    # Count critical issues
    $criticalCount = ($script:Results | Where-Object { $_.RiskLevel -eq "Critical" -and $_.Status -eq "FAIL" }).Count
    
    # HTML Template with embedded CSS and JavaScript
    $htmlTemplate = @"
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>$Title</title>
    <style>
        :root {
            --primary-color: #2563eb; --success-color: #059669; --warning-color: #d97706;
            --danger-color: #dc2626; --critical-color: #7c2d12; --info-color: #0891b2;
            --bg-light: #f8fafc; --bg-white: #ffffff; --text-dark: #1f2937;
            --text-gray: #6b7280; --border-color: #e5e7eb;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-light); color: var(--text-dark); line-height: 1.6; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, var(--primary-color) 0%, #1d4ed8 100%); color: white; padding: 2rem; border-radius: 12px; margin-bottom: 2rem; box-shadow: var(--shadow-lg); }
        .header h1 { font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem; }
        .header p { font-size: 1.1rem; opacity: 0.9; }
        .system-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .info-card { background: var(--bg-white); padding: 1.5rem; border-radius: 8px; box-shadow: var(--shadow); border-left: 4px solid var(--primary-color); }
        .info-card h3 { color: var(--text-gray); font-size: 0.875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; }
        .info-card p { font-size: 1.125rem; font-weight: 600; color: var(--text-dark); }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .metric-card { background: var(--bg-white); padding: 1.5rem; border-radius: 12px; box-shadow: var(--shadow); text-align: center; position: relative; overflow: hidden; }
        .metric-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; }
        .metric-card.pass::before { background: var(--success-color); }
        .metric-card.fail::before { background: var(--danger-color); }
        .metric-card.warn::before { background: var(--warning-color); }
        .metric-card.critical::before { background: var(--critical-color); }
        .metric-number { font-size: 3rem; font-weight: 700; margin-bottom: 0.5rem; }
        .metric-card.pass .metric-number { color: var(--success-color); }
        .metric-card.fail .metric-number { color: var(--danger-color); }
        .metric-card.warn .metric-number { color: var(--warning-color); }
        .metric-card.critical .metric-number { color: var(--critical-color); }
        .metric-label { font-size: 1rem; color: var(--text-gray); font-weight: 500; }
        .security-score { background: var(--bg-white); padding: 2rem; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 2rem; text-align: center; }
        .score-text { font-size: 3rem; font-weight: 700; color: var(--text-dark); }
        .score-label { font-size: 1.25rem; color: var(--text-gray); margin-bottom: 1rem; }
        .score-level { display: inline-block; padding: 0.5rem 1rem; border-radius: 20px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
        .level-excellent { background: #d1fae5; color: var(--success-color); }
        .level-good { background: #dbeafe; color: var(--primary-color); }
        .level-medium { background: #fef3c7; color: var(--warning-color); }
        .level-poor { background: #fecaca; color: var(--danger-color); }
        .progress-bar { width: 100%; height: 20px; background: #e5e7eb; border-radius: 10px; overflow: hidden; margin: 1rem 0; }
        .progress-fill { height: 100%; border-radius: 10px; transition: width 0.5s ease; background: linear-gradient(90deg, var(--danger-color) 0%, var(--warning-color) 50%, var(--success-color) 100%); }
        .filters { background: var(--bg-white); padding: 1.5rem; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 2rem; display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; }
        .filter-group { display: flex; align-items: center; gap: 0.5rem; }
        .filter-group label { font-weight: 500; color: var(--text-dark); }
        select, input { padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.875rem; }
        .btn { padding: 0.5rem 1rem; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .results-section { background: var(--bg-white); border-radius: 12px; box-shadow: var(--shadow); overflow: hidden; margin-bottom: 2rem; }
        .section-header { background: #f9fafb; padding: 1.5rem; border-bottom: 1px solid var(--border-color); }
        .section-title { font-size: 1.5rem; font-weight: 700; color: var(--text-dark); }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f9fafb; padding: 1rem; text-align: left; font-weight: 600; color: var(--text-dark); border-bottom: 1px solid var(--border-color); }
        td { padding: 1rem; border-bottom: 1px solid #f3f4f6; word-wrap: break-word; max-width: 300px; }
        tr:hover { background: #f9fafb; }
        .status-badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .status-pass { background: #d1fae5; color: var(--success-color); }
        .status-fail { background: #fecaca; color: var(--danger-color); }
        .status-warn { background: #fef3c7; color: var(--warning-color); }
        .status-info { background: #dbeafe; color: var(--info-color); }
        .risk-critical { background: #fef2f2; color: var(--critical-color); }
        .risk-high { background: #fecaca; color: var(--danger-color); }
        .risk-medium { background: #fef3c7; color: var(--warning-color); }
        .risk-low { background: #d1fae5; color: var(--success-color); }
        .critical-alert { background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 1rem; margin-bottom: 2rem; }
        .critical-alert h3 { color: var(--danger-color); margin-bottom: 0.5rem; }
        .critical-alert ul { margin-left: 1rem; color: var(--text-dark); }
        .recommendations { background: var(--bg-white); padding: 2rem; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 2rem; }
        .recommendation-item { background: #fef9e7; border-left: 4px solid var(--warning-color); padding: 1rem; margin-bottom: 1rem; border-radius: 0 6px 6px 0; }
        .recommendation-title { font-weight: 600; color: var(--text-dark); margin-bottom: 0.5rem; }
        .recommendation-desc { color: var(--text-gray); font-size: 0.9rem; }
        .footer { text-align: center; padding: 2rem; color: var(--text-gray); border-top: 1px solid var(--border-color); margin-top: 2rem; }
        @media (max-width: 768px) { .dashboard { grid-template-columns: repeat(2, 1fr); } .filters { flex-direction: column; align-items: stretch; } table { font-size: 0.875rem; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê $Title</h1>
            <p>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏£‡∏∞‡∏ö‡∏ö Windows ‡∏ï‡∏≤‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô CIS</p>
        </div>

        <div class="system-info">
            <div class="info-card"><h3>System</h3><p>$systemName</p></div>
            <div class="info-card"><h3>OS Version</h3><p>$osVersion</p></div>
            <div class="info-card"><h3>Audit Date</h3><p>$auditDate</p></div>
            <div class="info-card"><h3>Domain</h3><p>$domain</p></div>
        </div>

        <div class="security-score">
            <h2>Security Score</h2>
            <div class="score-text">$securityScore</div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: ${securityScore}%"></div>
            </div>
            <div class="score-label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°</div>
            <div class="score-level $securityLevelClass">$securityLevel</div>
        </div>

        <div class="dashboard">
            <div class="metric-card pass">
                <div class="metric-number">$($script:PassCount)</div>
                <div class="metric-label">Passed</div>
            </div>
            <div class="metric-card fail">
                <div class="metric-number">$($script:FailCount)</div>
                <div class="metric-label">Failed</div>
            </div>
            <div class="metric-card warn">
                <div class="metric-number">$($script:WarnCount)</div>
                <div class="metric-label">Warnings</div>
            </div>
            <div class="metric-card critical">
                <div class="metric-number">$criticalCount</div>
                <div class="metric-label">Critical Issues</div>
            </div>
        </div>
"@

    # Generate critical alert section
    $criticalIssues = $script:Results | Where-Object { $_.RiskLevel -eq "Critical" -and $_.Status -eq "FAIL" }
    if ($criticalIssues) {
        $criticalList = ($criticalIssues | ForEach-Object { "<li>$($_.Description)</li>" }) -join ""
        $htmlTemplate += @"

        <div class="critical-alert">
            <h3>‚ö†Ô∏è ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏î‡πà‡∏ß‡∏ô</h3>
            <ul>$criticalList</ul>
        </div>
"@
    }

    # Add filters and table
    $htmlTemplate += @"

        <div class="filters">
            <div class="filter-group">
                <label for="statusFilter">Status:</label>
                <select id="statusFilter" onchange="filterResults()">
                    <option value="">All</option>
                    <option value="PASS">Pass</option>
                    <option value="FAIL">Fail</option>
                    <option value="WARN">Warning</option>
                    <option value="INFO">Info</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="riskFilter">Risk Level:</label>
                <select id="riskFilter" onchange="filterResults()">
                    <option value="">All</option>
                    <option value="Critical">Critical</option>
                    <option value="High">High</option>
                    <option value="Medium">Medium</option>
                    <option value="Low">Low</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="searchFilter">Search:</label>
                <input type="text" id="searchFilter" placeholder="Search descriptions..." onkeyup="filterResults()">
            </div>
            <button class="btn btn-primary" onclick="exportCSV()">üìÑ Export CSV</button>
            <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Print</button>
        </div>

        <div class="results-section">
            <div class="section-header">
                <h2 class="section-title">Security Check Results</h2>
                <span style="float: right; color: var(--text-gray);">Total: $($script:TotalChecks) checks</span>
            </div>
            <div style="overflow-x: auto;">
                <table id="resultsTable">
                    <thead>
                        <tr>
                            <th>Check ID</th>
                            <th>Status</th>
                            <th>Description</th>
                            <th>Risk Level</th>
                            <th>Details</th>
                            <th>Recommendation</th>
                        </tr>
                    </thead>
                    <tbody>
"@

    # Generate table rows
    foreach ($result in $script:Results) {
        $statusClass = "status-" + $result.Status.ToLower()
        $riskClass = "risk-" + $result.RiskLevel.ToLower()
        
        $htmlTemplate += @"
                        <tr>
                            <td>$($result.CheckID)</td>
                            <td><span class="status-badge $statusClass">$($result.Status)</span></td>
                            <td>$($result.Description)</td>
                            <td><span class="status-badge $riskClass">$($result.RiskLevel)</span></td>
                            <td>$($result.Details)</td>
                            <td>$($result.Recommendation)</td>
                        </tr>
"@
    }

    # Generate recommendations
    $recommendationsList = ""
    if ($script:FailCount -gt 0 -or $script:WarnCount -gt 0) {
        $recommendationsList = @"
        <div class="recommendation-item">
            <div class="recommendation-title">1. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</div>
            <div class="recommendation-desc">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ FAIL ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏£‡∏∞‡∏î‡∏±‡∏ö Critical</div>
        </div>
        <div class="recommendation-item">
            <div class="recommendation-title">2. ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Windows ‡πÅ‡∏•‡∏∞ Security Patches</div>
            <div class="recommendation-desc">‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Windows Updates ‡πÅ‡∏•‡∏∞ security patches ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
        </div>
        <div class="recommendation-item">
            <div class="recommendation-title">3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Windows Defender</div>
            <div class="recommendation-desc">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ antivirus ‡πÅ‡∏•‡∏∞ firewall</div>
        </div>
        <div class="recommendation-item">
            <div class="recommendation-title">4. ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ Backup ‡πÅ‡∏•‡∏∞ Recovery Plan</div>
            <div class="recommendation-desc">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ automated backup ‡πÅ‡∏•‡∏∞‡∏ó‡∏î‡∏™‡∏≠‡∏ö disaster recovery procedures</div>
        </div>
"@
    } else {
        $recommendationsList = @"
        <div class="recommendation-item">
            <div class="recommendation-title">‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏î‡∏µ</div>
            <div class="recommendation-desc">‡∏Ñ‡∏ß‡∏£‡∏Ñ‡∏á‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á</div>
        </div>
"@
    }

    # Complete the HTML
    $htmlTemplate += @"
                    </tbody>
                </table>
            </div>
        </div>

        <div class="recommendations">
            <h2>üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á</h2>
            $recommendationsList
        </div>

        <div class="footer">
            <p>Generated by CIS Windows Security Audit Script | $generationTime</p>
            <p>‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡πÇ‡∏õ‡∏£‡∏î‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á CIS Benchmarks ‡πÅ‡∏•‡∏∞ security best practices</p>
        </div>
    </div>

    <script>
        function filterResults() {
            const statusFilter = document.getElementById('statusFilter').value;
            const riskFilter = document.getElementById('riskFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
            const tbody = document.querySelector('#resultsTable tbody');
            const rows = tbody.getElementsByTagName('tr');

            let visibleCount = 0;
            for (let row of rows) {
                let show = true;
                const cells = row.getElementsByTagName('td');
                
                if (cells.length > 0) {
                    const status = cells[1].textContent.trim();
                    const description = cells[2].textContent.toLowerCase();
                    const risk = cells[3].textContent.trim();

                    if (statusFilter && !status.includes(statusFilter)) show = false;
                    if (riskFilter && !risk.includes(riskFilter)) show = false;
                    if (searchFilter && !description.includes(searchFilter)) show = false;
                }

                row.style.display = show ? '' : 'none';
                if (show) visibleCount++;
            }

            // Update section header with visible count
            const sectionTitle = document.querySelector('.section-title');
            const totalSpan = sectionTitle.parentElement.querySelector('span');
            if (totalSpan) {
                totalSpan.textContent = 'Showing: ' + visibleCount + ' of $($script:TotalChecks) checks';
            }
        }

        function exportCSV() {
            const table = document.querySelector('table');
            const rows = Array.from(table.getElementsByTagName('tr'));
            const visibleRows = rows.filter(row => row.style.display !== 'none');
            
            let csv = '';
            visibleRows.forEach(row => {
                const cells = Array.from(row.getElementsByTagName('td')).concat(Array.from(row.getElementsByTagName('th')));
                const rowData = cells.map(cell => '"' + cell.textContent.replace(/"/g, '""') + '"').join(',');
                csv += rowData + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'windows_security_audit_filtered_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Animate numbers on load
            const numbers = document.querySelectorAll('.metric-number');
            numbers.forEach(num => {
                const target = parseInt(num.textContent);
                let current = 0;
                const increment = target / 20;
                const timer = setInterval(() => {
                    current += increment;
                    if (current >= target) {
                        current = target;
                        clearInterval(timer);
                    }
                    num.textContent = Math.floor(current);
                }, 50);
            });
        });
    </script>
</body>
</html>
"@

    # Write HTML file
    $htmlTemplate | Out-File -FilePath $htmlFile -Encoding UTF8
    
    Write-Host "HTML Report ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß: $htmlFile" -ForegroundColor Green
    Write-Host "‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏î‡πâ‡∏ß‡∏¢ web browser ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô" -ForegroundColor Cyan
    
    # Try to open with default browser
    try {
        Start-Process $htmlFile
    } catch {
        Write-Host "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå: $htmlFile" -ForegroundColor Yellow
    }
}

# Function to export CSV report
function Export-CSVReport {
    param(
        [string]$OutputPath = "C:\Temp"
    )
    
    $csvFile = Join-Path $OutputPath "CIS_Windows_Audit_Results_$(Get-Date -Format 'yyyyMMdd_HHmmss').csv"
    
    Write-Host "`n‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô CSV..." -ForegroundColor Cyan
    
    $script:Results | Export-Csv -Path $csvFile -NoTypeInformation -Encoding UTF8
    
    Write-Host "CSV Report ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß: $csvFile" -ForegroundColor Green
}

# Generate summary report
function Show-Summary {
    Write-Host "`n=== ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ===" -ForegroundColor $Colors.HEADER
    Write-Host "‡∏ú‡πà‡∏≤‡∏ô (PASS): $script:PassCount" -ForegroundColor $Colors.PASS
    Write-Host "‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô (FAIL): $script:FailCount" -ForegroundColor $Colors.FAIL
    Write-Host "‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (WARN): $script:WarnCount" -ForegroundColor $Colors.WARN
    Write-Host "‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: $script:TotalChecks" -ForegroundColor White
    
    if ($script:TotalChecks -gt 0) {
        $securityScore = [math]::Round(($script:PassCount * 100) / $script:TotalChecks, 1)
        Write-Host "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢: $securityScore/100" -ForegroundColor Cyan
        
        if ($securityScore -ge 85) {
            Write-Host "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢: ‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°" -ForegroundColor $Colors.PASS
        } elseif ($securityScore -ge 70) {
            Write-Host "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢: ‡∏î‡∏µ" -ForegroundColor $Colors.PASS
        } elseif ($securityScore -ge 50) {
            Write-Host "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢: ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á" -ForegroundColor $Colors.WARN
        } else {
            Write-Host "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢: ‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏î‡πà‡∏ß‡∏ô" -ForegroundColor $Colors.FAIL
        }
    }
    
    # Show critical issues
    $criticalIssues = $script:Results | Where-Object { $_.RiskLevel -eq "Critical" -and $_.Status -eq "FAIL" }
    if ($criticalIssues) {
        Write-Host "`n‚ö†Ô∏è  ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏î‡πà‡∏ß‡∏ô:" -ForegroundColor Red
        foreach ($issue in $criticalIssues) {
            Write-Host "   ‚Ä¢ $($issue.Description)" -ForegroundColor Red
        }
    }
    
    Write-Host "`n‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà: $script:LogFile" -ForegroundColor Cyan
    
    if ($script:FailCount -gt 0 -or $script:WarnCount -gt 0) {
        Write-Host "`n=== ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á ===" -ForegroundColor $Colors.WARN
        Write-Host "1. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ FAIL ‡πÅ‡∏•‡∏∞ RiskLevel Critical ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ"
        Write-Host "2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ FAIL ‡∏≠‡∏∑‡πà‡∏ô‡πÜ"
        Write-Host "3. ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ WARN ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°"
        Write-Host "4. ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ backup ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"
        Write-Host "5. ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Windows Updates ‡πÅ‡∏•‡∏∞ security patches"
        Write-Host "6. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ monitoring ‡πÅ‡∏•‡∏∞ alerting"
    }
    
    # Export reports if requested
    if ($ExportHTML) {
        Export-HTMLReport -OutputPath $OutputPath -Title $ReportTitle
    }
    
    if ($ExportCSV -or $ExportResults) {
        Export-CSVReport -OutputPath $OutputPath
    }
}

# Show help
function Show-Help {
    Write-Host "CIS Windows 10/11 Security Audit Script v2.0" -ForegroundColor $Colors.HEADER
    Write-Host "‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: .\CIS_Windows_Audit.ps1 [parameters]" -ForegroundColor White
    Write-Host ""
    Write-Host "Parameters:" -ForegroundColor Cyan
    Write-Host "  -Help                   ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô"
    Write-Host "  -CreateHardening        ‡∏™‡∏£‡πâ‡∏≤‡∏á hardening script"
    Write-Host "  -ExportResults          Export ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏õ‡πá‡∏ô CSV"
    Write-Host "  -ExportHTML             Export ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏õ‡πá‡∏ô HTML"
    Write-Host "  -ExportCSV              Export ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏õ‡πá‡∏ô CSV"
    Write-Host "  -OutputPath <path>      ‡∏Å‡∏≥‡∏´‡∏ô‡∏î path ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö output files (default: C:\Temp)"
    Write-Host "  -ReportTitle <title>    ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô"
    Write-Host "  -CustomSystemInfo <json> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (JSON format)"
    Write-Host ""
    Write-Host "‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:" -ForegroundColor Yellow
    Write-Host "  .\CIS_Windows_Audit.ps1 -ExportHTML"
    Write-Host "  .\CIS_Windows_Audit.ps1 -ExportHTML -ExportCSV -OutputPath D:\SecurityReports"
    Write-Host "  .\CIS_Windows_Audit.ps1 -ExportHTML -ReportTitle 'Custom Security Report'"
    Write-Host ""
    Write-Host "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ô‡πÉ‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Administrator" -ForegroundColor Red
}

# Create hardening script
function New-HardeningScript {
    $hardeningScript = @"
# CIS Windows 10/11 Hardening Script
# ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∞‡∏°‡∏±‡∏î‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ô script ‡∏ô‡∏µ‡πâ
# ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ backup ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏° test ‡∏Å‡πà‡∏≠‡∏ô

Write-Host "‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ hardening ‡∏£‡∏∞‡∏ö‡∏ö Windows ‡∏ï‡∏≤‡∏° CIS" -ForegroundColor Yellow
Write-Host "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ backup ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô" -ForegroundColor Red
`$confirm = Read-Host "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (y/N)"

if (`$confirm -ne 'y' -and `$confirm -ne 'Y') {
    Write-Host "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£" -ForegroundColor Red
    exit
}

Write-Host "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£ hardening ‡∏£‡∏∞‡∏ö‡∏ö..." -ForegroundColor Green

# Create system restore point
Write-Host "‡∏™‡∏£‡πâ‡∏≤‡∏á System Restore Point..." -ForegroundColor Cyan
Checkpoint-Computer -Description "Pre-CIS-Hardening" -RestorePointType "MODIFY_SETTINGS"

# Account Policies
Write-Host "‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ Account Policies..." -ForegroundColor Cyan
# This requires secedit - implement based on findings

# Disable Guest Account
Write-Host "‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Guest Account..." -ForegroundColor Cyan
try {
    Disable-LocalUser -Name "Guest"
    Write-Host "‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Guest account ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" -ForegroundColor Green
}
catch {
    Write-Host "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Guest account ‡πÑ‡∏î‡πâ" -ForegroundColor Yellow
}

# Windows Firewall
Write-Host "‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Windows Firewall..." -ForegroundColor Cyan
Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled True
Set-NetFirewallProfile -Profile Domain,Public,Private -DefaultInboundAction Block -DefaultOutboundAction Allow

# Enable UAC
Write-Host "‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô UAC..." -ForegroundColor Cyan
Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -Name "EnableLUA" -Value 1 -Force

# Registry Security Settings
Write-Host "‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ Registry Security..." -ForegroundColor Cyan
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa" -Name "LimitBlankPasswordUse" -Value 1 -Force
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa" -Name "NoLMHash" -Value 1 -Force

# PowerShell Execution Policy
Write-Host "‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ PowerShell Execution Policy..." -ForegroundColor Cyan
Set-ExecutionPolicy RemoteSigned -Force

# Disable unnecessary services
Write-Host "‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô services ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô..." -ForegroundColor Cyan
`$servicesToDisable = @("TlntSvr", "MSFTPSVC", "RemoteRegistry", "Messenger")
foreach (`$service in `$servicesToDisable) {
    try {
        Stop-Service `$service -Force -ErrorAction SilentlyContinue
        Set-Service `$service -StartupType Disabled -ErrorAction SilentlyContinue
        Write-Host "‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô `$service ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" -ForegroundColor Green
    }
    catch {
        Write-Host "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô `$service ‡πÑ‡∏î‡πâ (‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á)" -ForegroundColor Yellow
    }
}

Write-Host "‡∏Å‡∏≤‡∏£ hardening ‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô" -ForegroundColor Green
Write-Host "‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ restart ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á" -ForegroundColor Yellow
"@

    $hardeningPath = Join-Path $OutputPath "CIS_Windows_Hardening.ps1"
    $hardeningScript | Out-File -FilePath $hardeningPath -Encoding UTF8
    Write-Host "‡∏™‡∏£‡πâ‡∏≤‡∏á hardening script ‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà: $hardeningPath" -ForegroundColor Green
}

# Main execution
if ($Help) {
    Show-Help
    exit
}

if ($CreateHardening) {
    Initialize-Script
    New-HardeningScript
    exit
}

# Run security audit
try {
    Initialize-Script
    Get-SystemInfo
    Test-AccountPolicies
    Test-LocalPolicies
    Test-WindowsFirewall
    Test-WindowsDefender
    Test-WindowsUpdates
    Show-Summary
    
    Write-Host "`n‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!" -ForegroundColor $Colors.PASS
}
catch {
    Write-Host "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ô script: $($_.Exception.Message)" -ForegroundColor Red
    Write-Host "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á required modules" -ForegroundColor Yellow
}